<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Apoio à Decisão - Emergência</title>
    <style>
        /* Mantenha todos os estilos CSS existenteeees */
        :root {
            --primary-color: #1a73e8;
            --danger-color: #d32f2f;
            --warning-color: #f57c00;
            --success-color: #388e3c;
            --light-bg: #f5f5f5;
            --border-color: #ddd;
            --text-dark: #333;
            --text-light: #666;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* ... manter todo o CSS original ... */

        /* Adicionar estilos para o login modal */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .login-modal.active {
            display: flex;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .login-header h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .login-form .form-group {
            margin-bottom: 1rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }

        .login-form button {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        .login-form button:hover {
            background: #0d47a1;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        .user-info-header {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .user-name {
            font-weight: 500;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .logout-btn:hover {
            background: rgba(211, 47, 47, 0.1);
        }
    </style>
</head>
<body>
    <!-- Modal de Login -->
    <div id="loginModal" class="login-modal active">
        <div class="login-container">
            <div class="login-header">
                <h2>Sistema de Apoio à Decisão - Emergência</h2>
                <p>Faça login para acessar o sistema</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="loginNome">Nome</label>
                    <input type="text" id="loginNome" placeholder="Digite seu nome" required>
                </div>
                <div class="form-group">
                    <label for="loginCRM">CRM</label>
                    <input type="text" id="loginCRM" placeholder="Digite seu CRM" required>
                </div>
                <div id="loginError" class="error-message">
                    Credenciais inválidas. Por favor, verifique seus dados.
                </div>
                <button type="submit">Entrar</button>
            </form>
        </div>
    </div>

    <div class="container" style="display: none;" id="mainApp">
        <!-- Cabeçalho com informações do usuário -->
        <div class="user-info-header">
            <span class="user-name" id="currentUserName">Médico</span>
            <button class="logout-btn" id="logoutBtn">Sair</button>
        </div>

        <div class="header">
            <h1>Sistema de Apoio à Decisão - Emergência</h1>
            <div class="subtitle">Protocolos baseados no guia "Plantão Rápido" - Atendimento em UPA/PS</div>
            <div class="time-display" id="current-time">Carregando...</div>
        </div>

        <!-- Restante do código HTML permanece igual -->
        <div class="tabs">
            <div class="tab active" data-tab="patient">Dados do Paciente</div>
            <div class="tab" data-tab="condition">Condição Clínica</div>
            <div class="tab" data-tab="prescription">Prescrição</div>
        </div>

        <!-- ... resto do HTML original ... -->
        <div class="tab-content active" id="patient-tab">
            <!-- Conteúdo original -->
        </div>
        
        <div class="tab-content" id="condition-tab">
            <!-- Conteúdo original -->
        </div>
        
        <div class="tab-content" id="prescription-tab">
            <!-- Conteúdo original -->
        </div>
    </div>

    <script>
        // Dados baseados no arquivo fornecido (mantenha os dados originais)
        const conditionsData = {
            // ... manter todos os dados das condições ...
            pcr: {
                name: "Parada Cardiorrespiratória / Instabilidade Hemodinâmica",
                exam: `
                    <div class="exam-field">
                        <label>ABCDE Avaliado:</label>
                        <select class="form-control">
                            <option>Sim, completo</option>
                            <option>Parcialmente</option>
                            <option>Não realizado</option>
                        </select>
                    </div>
                    <!-- ... resto do conteúdo ... -->
                `,
                emergencyMeds: [
                    "Adrenalina 1mg/ml (1:1000) - 0,3-0,5mg IM (anafilaxia)",
                    "Adrenalina 1mg/10ml (1:10.000) - 1mg EV (PCR)",
                    // ... resto dos medicamentos ...
                ],
                homePrescription: `
                    <div class="prescription-card">
                        <div class="prescription-title">Encaminhamento Hospitalar</div>
                        <p>Paciente em instabilidade hemodinâmica requer internação em UTI.</p>
                        <p><strong>Conduta:</strong> Transferência imediata para unidade de referência com suporte avançado.</p>
                    </div>
                `
            },
            // ... outras condições ...
        };

        // Estado da aplicação
        let currentCondition = null;
        let currentTab = 'patient';
        let medicoLogado = null;

        // Elementos DOM
        const loginModal = document.getElementById('loginModal');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const currentUserName = document.getElementById('currentUserName');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Elementos originais
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const conditionCards = document.querySelectorAll('.condition-card');
        const patientNameInput = document.getElementById('patient-name');
        const patientDobInput = document.getElementById('patient-dob');
        const patientAgeInput = document.getElementById('patient-age');
        const patientSusInput = document.getElementById('patient-sus');
        const patientGenderSelect = document.getElementById('patient-gender');
        const specificExamDiv = document.getElementById('specific-exam');
        const emergencyMedsDiv = document.getElementById('emergency-medications');
        const homePrescriptionDiv = document.getElementById('home-prescription');
        const currentTimeDiv = document.getElementById('current-time');

        // Funções de login/logout
        function verificarLogin() {
            const medicoSalvo = localStorage.getItem('medicoLogadoEmergencia');
            if (medicoSalvo) {
                medicoLogado = JSON.parse(medicoSalvo);
                mostrarApp();
            } else {
                mostrarLogin();
            }
        }

        function mostrarLogin() {
            loginModal.classList.add('active');
            mainApp.style.display = 'none';
        }

        function mostrarApp() {
            loginModal.classList.remove('active');
            mainApp.style.display = 'block';
            currentUserName.textContent = medicoLogado.nome;
            
            // Inicializar a aplicação
            initApp();
        }

        function fazerLogin(nome, crm) {
            // Simulação de validação - você pode adicionar validação real aqui
            if (nome && crm) {
                medicoLogado = {
                    nome: nome,
                    crm: crm,
                    dataLogin: new Date().toISOString()
                };
                
                localStorage.setItem('medicoLogadoEmergencia', JSON.stringify(medicoLogado));
                mostrarApp();
                return true;
            }
            return false;
        }

        function fazerLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                localStorage.removeItem('medicoLogadoEmergencia');
                medicoLogado = null;
                mostrarLogin();
                resetarFormularios();
            }
        }

        // Eventos de login/logout
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('loginNome').value.trim();
            const crm = document.getElementById('loginCRM').value.trim();
            
            if (fazerLogin(nome, crm)) {
                loginError.style.display = 'none';
            } else {
                loginError.style.display = 'block';
            }
        });

        logoutBtn.addEventListener('click', fazerLogout);

        // Funções originais da aplicação (com pequenas modificações)
        function initApp() {
            // Inicializar apenas se estiver logado
            if (!medicoLogado) return;
            
            // Atualizar hora atual
            updateCurrentTime();
            
            // Configurar eventos
            initEvents();
            
            console.log('Sistema de Emergência inicializado para:', medicoLogado.nome);
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            currentTimeDiv.textContent = `${dateString} ${timeString}`;
        }

        // Função para resetar formulários ao sair
        function resetarFormularios() {
            if (patientNameInput) patientNameInput.value = '';
            if (patientDobInput) patientDobInput.value = '';
            if (patientAgeInput) patientAgeInput.value = '';
            if (patientSusInput) patientSusInput.value = '';
            if (patientGenderSelect) patientGenderSelect.value = '';
            
            conditionCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            currentCondition = null;
            currentTab = 'patient';
            switchTab('patient');
            
            if (specificExamDiv) {
                specificExamDiv.innerHTML = `
                    <p class="alert-box alert-info">
                        <span class="icon">ℹ️</span>
                        Selecione uma condição clínica na aba anterior para visualizar o exame físico específico e as prescrições.
                    </p>`;
            }
                
            if (homePrescriptionDiv) {
                homePrescriptionDiv.innerHTML = `
                    <p class="alert-box alert-info">
                        <span class="icon">ℹ️</span>
                        Selecione uma condição clínica para visualizar a prescrição para alta.
                    </p>`;
            }
        }

        // Funções originais (mantenha todas as funções originais da aplicação)
        function switchTab(tabName) {
            // Atualizar estado
            currentTab = tabName;
            
            // Atualizar abas visuais
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Atualizar conteúdo das abas
            tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function selectCondition(conditionId) {
            // Remover seleção anterior
            conditionCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            // Adicionar seleção à nova condição
            const selectedCard = document.querySelector(`[data-condition="${conditionId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Atualizar estado
            currentCondition = conditionId;
            
            // Atualizar exame físico e prescrições se estiver na aba de prescrição
            if (currentTab === 'prescription') {
                updatePrescriptionTab();
            }
        }

        function updatePrescriptionTab() {
            if (!currentCondition || !conditionsData[currentCondition]) {
                specificExamDiv.innerHTML = `
                    <p class="alert-box alert-info">
                        <span class="icon">ℹ️</span>
                        Selecione uma condição clínica na aba anterior para visualizar o exame físico específico e as prescrições.
                    </p>`;
                homePrescriptionDiv.innerHTML = `
                    <p class="alert-box alert-info">
                        <span class="icon">ℹ️</span>
                        Selecione uma condição clínica para visualizar a prescrição para alta.
                    </p>`;
                return;
            }
            
            const condition = conditionsData[currentCondition];
            
            // Atualizar exame físico específico
            specificExamDiv.innerHTML = `
                <div class="alert-box alert-info">
                    <span class="icon">ℹ️</span>
                    <strong>${condition.name}</strong> - Exame Físico Específico
                </div>
                ${condition.exam}`;
            
            // Atualizar medicamentos de emergência
            emergencyMedsDiv.innerHTML = '';
            condition.emergencyMeds.forEach(med => {
                const medDiv = document.createElement('div');
                medDiv.className = 'emergency-med';
                medDiv.textContent = med;
                emergencyMedsDiv.appendChild(medDiv);
            });
            
            // Atualizar prescrição para alta
            homePrescriptionDiv.innerHTML = condition.homePrescription;
        }

        function calculateAge() {
            if (!patientDobInput.value) return;
            
            const birthDate = new Date(patientDobInput.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            patientAgeInput.value = age;
        }

        function printPrescription() {
            if (!currentCondition) {
                alert('Selecione uma condição clínica antes de imprimir a prescrição.');
                return;
            }
            
            const condition = conditionsData[currentCondition];
            const patientName = patientNameInput.value || '[NÃO INFORMADO]';
            const patientAge = patientAgeInput.value || '[NÃO INFORMADO]';
            const patientSus = patientSusInput.value || '[NÃO INFORMADO]';
            const patientGender = patientGenderSelect.value || '[NÃO INFORMADO]';
            const genderText = patientGender === 'male' ? 'Masculino' : 
                             patientGender === 'female' ? 'Feminino' : 
                             '[NÃO INFORMADO]';
            
            // Adicionar informações do médico logado
            const medicoNome = medicoLogado ? medicoLogado.nome : '[MÉDICO NÃO IDENTIFICADO]';
            const medicoCRM = medicoLogado ? medicoLogado.crm : '[CRM NÃO INFORMADO]';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Prescrição Médica - ${patientName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; }
                        .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .patient-info { margin-bottom: 30px; }
                        .section { margin-bottom: 25px; }
                        .section-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .medication { margin-bottom: 15px; }
                        .medication-name { font-weight: bold; }
                        .footer { margin-top: 50px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 12px; }
                        @media print {
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Prescrição Médica - Emergência</h1>
                        <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                        <p><strong>Médico:</strong> ${medicoNome} - ${medicoCRM}</p>
                    </div>
                    
                    <div class="patient-info">
                        <h2>Dados do Paciente</h2>
                        <p><strong>Nome:</strong> ${patientName}</p>
                        <p><strong>Idade:</strong> ${patientAge} anos</p>
                        <p><strong>Sexo:</strong> ${genderText}</p>
                        <p><strong>SUS:</strong> ${patientSus}</p>
                        <p><strong>Condição:</strong> ${condition.name}</p>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Medicamentos para Uso na Emergência</div>
                        ${condition.emergencyMeds.map(med => `
                            <div class="medication">
                                <div class="medication-name">${med}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Prescrição para Alta / Ambulatorial</div>
                        ${condition.homePrescription.replace(/<[^>]*>/g, '')}
                    </div>
                    
                    <div class="footer">
                        <p>Prescrição gerada pelo Sistema de Apoio à Decisão - Emergência</p>
                        <p>Baseado no protocolo "Plantão Rápido"</p>
                        <p>Médico responsável: ${medicoNome} - ${medicoCRM}</p>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function clearForm() {
            resetarFormularios();
        }

        function initEvents() {
            // Navegação entre abas
            document.getElementById('next-to-condition').addEventListener('click', () => {
                switchTab('condition');
            });
            
            document.getElementById('back-to-patient').addEventListener('click', () => {
                switchTab('patient');
            });
            
            document.getElementById('next-to-prescription').addEventListener('click', () => {
                if (!currentCondition) {
                    alert('Por favor, selecione uma condição clínica antes de prosseguir.');
                    return;
                }
                switchTab('prescription');
                updatePrescriptionTab();
            });
            
            document.getElementById('back-to-condition').addEventListener('click', () => {
                switchTab('condition');
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    if (tabName === 'prescription' && !currentCondition) {
                        alert('Por favor, selecione uma condição clínica antes de acessar as prescrições.');
                        return;
                    }
                    switchTab(tabName);
                    if (tabName === 'prescription') {
                        updatePrescriptionTab();
                    }
                });
            });
            
            // Seleção de condições clínicas
            conditionCards.forEach(card => {
                card.addEventListener('click', () => {
                    const conditionId = card.dataset.condition;
                    selectCondition(conditionId);
                });
            });
            
            // Calcular idade automaticamente
            patientDobInput.addEventListener('change', calculateAge);
            
            // Botões de ação
            document.getElementById('print-prescription').addEventListener('click', printPrescription);
            document.getElementById('new-patient').addEventListener('click', clearForm);
            
            // Atualizar hora a cada segundo
            setInterval(updateCurrentTime, 1000);
        }

        // Inicializar verificação de login quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', verificarLogin);
    </script>
</body>
</html>
